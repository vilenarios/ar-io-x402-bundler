# AR.IO Bundler Lite - x402 Configuration
# Copy this file to .env and fill in your values
#
# Quick Start:
#   1. cp .env.sample .env
#   2. Set ARWEAVE_WALLET_FILE to absolute path of your wallet
#   3. Set X402_PAYMENT_ADDRESS to your Ethereum address
#   4. Generate ADMIN_PASSWORD: openssl rand -hex 32
#   5. Run: ./start-bundler.sh

#############################################
# Service Configuration
#############################################
NODE_ENV=production
PORT=3001
LOG_LEVEL=info

#############################################
# HTTP Server Timeouts
#############################################
# Request timeout (milliseconds)
# How long to wait for a request to complete before timing out
# For large file uploads (10 GiB @ 10 MB/s = ~1000 seconds), set high
# Default: 600000 ms (10 minutes)
REQUEST_TIMEOUT_MS=600000

# Headers timeout (milliseconds)
# Must be greater than REQUEST_TIMEOUT_MS to avoid race conditions
# Default: 620000 ms (10 minutes 20 seconds)
HEADERS_TIMEOUT_MS=620000

# Keep-alive timeout (milliseconds)
# How long to keep idle connections alive
# Should be greater than load balancer/proxy timeout
# Default: 120000 ms (2 minutes)
KEEP_ALIVE_TIMEOUT_MS=120000

#############################################
# Database Configuration
#############################################
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_DATABASE=bundler_lite

#############################################
# Database Connection Pool Configuration
#############################################
# Connection pool settings for high-throughput operations
# Increase these values if you experience "Knex: Timeout acquiring a connection" errors

# Minimum number of connections to maintain (always connected)
DB_POOL_MIN=10

# Maximum number of concurrent database connections
# Rule of thumb: max = (expected_concurrent_uploads * 2) + 10
# For 100 uploads/sec: 100 * 2 + 10 = 210 (use 50 for safety margin)
DB_POOL_MAX=50

# How long to keep idle connections alive (milliseconds)
# Lower = less resource usage, higher = faster response on burst traffic
DB_POOL_IDLE_TIMEOUT_MS=30000

# How long to wait for an available connection before timing out (milliseconds)
# Increase if you see timeout errors under load
DB_POOL_ACQUIRE_TIMEOUT_MS=60000

# How long to wait when creating a new database connection (milliseconds)
DB_POOL_CREATE_TIMEOUT_MS=30000

# How often to check for expired connections (milliseconds)
DB_POOL_REAP_INTERVAL_MS=1000

# Retry interval when connection creation fails (milliseconds)
DB_POOL_CREATE_RETRY_INTERVAL_MS=200

# Enable debug logging for database connection pool (development only)
# DB_DEBUG=true

#############################################
# Redis Configuration
#############################################
# Redis for caching (Elasticache-compatible)
ELASTICACHE_HOST=localhost
ELASTICACHE_PORT=6379
ELASTICACHE_NO_CLUSTERING=true

# Redis for job queues (BullMQ)
REDIS_HOST=localhost
REDIS_PORT_QUEUES=6381

#############################################
# Object Storage (MinIO/S3)
#############################################
AWS_REGION=us-east-1
AWS_ENDPOINT=http://localhost:9000
DATA_ITEM_BUCKET=bundler-data-items
S3_FORCE_PATH_STYLE=true

# MinIO credentials (CHANGE FOR PRODUCTION!)
# IMPORTANT: MINIO_ROOT_USER/PASSWORD must match AWS_ACCESS_KEY_ID/SECRET_ACCESS_KEY
# Generate secure password with: openssl rand -hex 16
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin

# AWS SDK credentials (must match MinIO credentials above)
AWS_ACCESS_KEY_ID=minioadmin
AWS_SECRET_ACCESS_KEY=minioadmin

#############################################
# Arweave Configuration
#############################################
# Gateway for posting bundles to Arweave
ARWEAVE_GATEWAY=https://arweave.net

# Gateway advertised to users for reading their data (shown in info endpoint)
# Set this to your AR.IO gateway if you're running one
PUBLIC_ACCESS_GATEWAY=https://arweave.nexus

# IMPORTANT: Must be an ABSOLUTE path (not relative)
# Example: /home/user/wallets/bundler-wallet.json
ARWEAVE_WALLET_FILE=/absolute/path/to/your/arweave-wallet.json

#############################################
# x402 Payment Configuration
#############################################

# REQUIRED: Your EVM address to receive USDC payments
# Example: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb1
X402_PAYMENT_ADDRESS=

# PRODUCTION REQUIRED: Public URL of your upload service
# This URL is used in x402 payment requirement responses
# MUST be set for production (payment flows will fail without it)
# Example: https://upload.services.vilenarios.com
# Local development default: http://localhost:3001
UPLOAD_SERVICE_PUBLIC_URL=http://localhost:3001

# Coinbase CDP Credentials (REQUIRED for Base mainnet)
# Get from: https://portal.cdp.coinbase.com/
# Leave empty for testnet (Base Sepolia works without CDP)
CDP_API_KEY_ID=
CDP_API_KEY_SECRET=

# ============================================================
# TESTNET QUICK START (Base Sepolia)
# ============================================================
# To use Base Sepolia testnet instead of mainnet:
#   1. Add this line (networks are disabled by default except Base mainnet):
#      X402_BASE_TESTNET_ENABLED=true
#   2. Optionally disable mainnet:
#      X402_BASE_ENABLED=false
#   3. No CDP credentials needed for testnet!
#
# See "x402 Network Configuration" in Advanced Configuration section below.
# ============================================================

# x402 Facilitator Configuration (Multi-Facilitator Fallback)
# Provide comma-separated list of facilitators (tries in order until one succeeds)
#
# Base mainnet facilitators (default if not set):
#   1. https://api.cdp.coinbase.com/platform/v2/x402 (Coinbase - primary)
#   2. https://facilitator.mogami.tech (Mogami - fallback)
#
# Examples:
# X402_FACILITATORS_BASE=https://facilitator1.com,https://facilitator2.com,https://facilitator3.com
# X402_FACILITATORS_BASE=https://api.cdp.coinbase.com/platform/v2/x402,https://facilitator.mogami.tech
#
# Leave commented to use defaults:
# X402_FACILITATORS_BASE=

# Base Sepolia testnet facilitators
# Default (if not set): https://facilitator.mogami.tech (no CDP required)
# X402_FACILITATORS_BASE_TESTNET=https://facilitator.mogami.tech

# Optional: Ethereum mainnet facilitators (comma-separated)
# No default - must configure if enabling Ethereum
# X402_FACILITATORS_ETH=https://facilitator1.com,https://facilitator2.com

# Optional: Polygon mainnet facilitators (comma-separated)
# No default - must configure if enabling Polygon
# X402_FACILITATORS_POLYGON=https://facilitator1.com,https://facilitator2.com

# x402 Advanced Settings (optional)
X402_FRAUD_TOLERANCE_PERCENT=5         # Â±5% byte count tolerance
X402_FEE_PERCENT=30                    # 30% bundler fee (profit margin on top of Arweave costs)
X402_PAYMENT_TIMEOUT_MS=3600000        # 1 hour payment timeout (3600000ms = 1 hour)
X402_MINIMUM_PAYMENT_USDC=0.001        # Minimum payment in USDC (Coinbase facilitator minimum)

#############################################
# Info Endpoint Configuration
#############################################
# Ethereum address shown in info endpoint (defaults to X402_PAYMENT_ADDRESS)
# ETHEREUM_ADDRESS=0x...

# Free upload limit in bytes (0 = all uploads require payment)
FREE_UPLOAD_LIMIT=0

#############################################
# Bundling Configuration
#############################################
# Maximum size of a single data item (10 GB default)
MAX_DATA_ITEM_SIZE=10737418240

# Maximum bundle size in bytes (250 MB default)
MAX_BUNDLE_SIZE=250000000

# Bundle metadata tags - added to all bundle transactions on Arweave
APP_NAME="AR.IO Bundler"

# Enable optical bridging to AR.IO gateway (requires OPTICAL_BRIDGE_URL)
OPTICAL_BRIDGING_ENABLED=true

#############################################
# Data Cleanup Configuration
#############################################
# How many days to keep filesystem backups before cleanup
# Filesystem backups are used as hot cache during bundling
# After bundling, items are in MinIO + Arweave, so filesystem can be cleaned
FILESYSTEM_CLEANUP_DAYS=7

# How many days to keep MinIO data before cleanup
# MinIO is cold storage for disaster recovery and re-bundling
# After this period, items are only in Arweave (permanent storage)
MINIO_CLEANUP_DAYS=90

# Cleanup job schedule (cron format)
# Default: "0 2 * * *" (daily at 2 AM UTC)
# Examples:
#   "0 */6 * * *"  - Every 6 hours
#   "0 3 * * 0"    - Weekly on Sunday at 3 AM
#   "0 1 1 * *"    - Monthly on the 1st at 1 AM
CLEANUP_CRON="0 2 * * *"

#############################################
# Optional: Allow-listed Addresses (Free Uploads)
#############################################
ALLOW_LISTED_ADDRESSES=

#############################################
# Optional: Raw Data Uploads
#############################################
# Enable raw data uploads (for AI agents that can't create ANS-104 data items)
# When enabled, bundler will create and sign data items on behalf of users
# RAW_DATA_UPLOADS_ENABLED=true

# Wallet for signing raw data items (can be same as ARWEAVE_WALLET_FILE or separate)
# IMPORTANT: Must be an ABSOLUTE path (not relative)
# If using Docker and a different wallet than ARWEAVE_WALLET_FILE, ensure it's accessible
# Example: /home/user/wallets/raw-data-wallet.json
# RAW_DATA_ITEM_JWK_FILE=/absolute/path/to/your/raw-data-wallet.json

#############################################
# Optional: AR.IO Gateway Integration
#############################################
# OPTICAL_BRIDGE_URL=http://localhost:4000/ar-io/admin/queue-data-item
# AR_IO_ADMIN_KEY=your-admin-key

#############################################
# Admin Dashboard Configuration
#############################################

# REQUIRED: Admin credentials for dashboard access
ADMIN_USERNAME=admin

# Generate with: openssl rand -hex 32
# The start-bundler.sh script will auto-generate if not set
ADMIN_PASSWORD=

# Dashboard port (default: 3002)
BULL_BOARD_PORT=3002

#############################################
# Advanced Configuration (Optional)
#############################################
# These variables have sensible defaults and are only needed for
# advanced deployments, scaling, or specific integrations.

# x402 Network Configuration
# Enable/disable specific payment networks (defaults shown)
# X402_BASE_ENABLED=true                  # Base mainnet (default: enabled)
# X402_BASE_TESTNET_ENABLED=false         # Base Sepolia testnet (default: disabled)
# X402_ETH_ENABLED=false                  # Ethereum mainnet (default: disabled)
# X402_POLYGON_ENABLED=false              # Polygon mainnet (default: disabled)

# x402 Network Confirmations (defaults shown)
# X402_BASE_MIN_CONFIRMATIONS=1           # Base confirmations (default: 1 block)
# X402_ETH_MIN_CONFIRMATIONS=3            # Ethereum confirmations (default: 3 blocks)
# X402_POLYGON_MIN_CONFIRMATIONS=10       # Polygon confirmations (default: 10 blocks)

# Custom RPC Endpoints (optional - uses public RPCs by default)
# BASE_MAINNET_RPC_URL=https://mainnet.base.org
# BASE_SEPOLIA_RPC_URL=https://sepolia.base.org
# ETHEREUM_MAINNET_RPC_URL=https://cloudflare-eth.com/
# POLYGON_MAINNET_RPC_URL=https://polygon-rpc.com/

# Database Scaling (optional - for read replicas)
# DB_WRITER_ENDPOINT=primary-db.example.com     # Primary database endpoint
# DB_READER_ENDPOINT=replica-db.example.com     # Read replica endpoint
# POSTGRES_VERSION=16.1                         # PostgreSQL version

# Redis Authentication (optional - for secured Redis)
# ELASTICACHE_PASSWORD=your-redis-password
# ELASTICACHE_USE_TLS=true

# S3 Backup Configuration (optional - for disaster recovery)
# BACKUP_DATA_ITEM_BUCKET=bundler-backups       # Separate backup bucket
# DATA_ITEM_BUCKET_REGION=us-east-1             # Primary bucket region
# BACKUP_BUCKET_REGION=us-west-2                # Backup bucket region
# S3_REGION=us-east-1                           # Default S3 region

# Observability (optional - for production monitoring)
# HONEYCOMB_API_KEY=your-honeycomb-api-key      # Honeycomb observability
# OTEL_SAMPLE_RATE=0.1                          # OpenTelemetry sampling (0.0-1.0)

# Logging Configuration (optional)
# LOG_FORMAT=json                               # Options: simple, json
# LOG_ALL_STACKTRACES=false                     # Log all stack traces
# DISABLE_LOGS=false                            # Disable all logging

# Multipart Upload Advanced (optional)
# MULTIPART_DEPOSIT_USDC=0.1                    # Deposit amount for multipart uploads
# MULTIPART_UPLOAD_TTL_HOURS=24                 # TTL for multipart uploads
# MULTIPART_MAX_PER_ADDRESS=10                  # Max concurrent multipart uploads per address

# Database Migration (optional - usually not needed)
# MIGRATE_ON_STARTUP=false                      # Run migrations on startup

# Arweave Advanced (optional)
# ARWEAVE_UPLOAD_NODE=https://arweave.net       # Separate node for chunk uploads
# ARWEAVE_NETWORK_REQUEST_TIMEOUT_MS=30000      # Network timeout for Arweave requests

# Bundle Configuration Advanced (optional)
# MAX_DATA_ITEM_LIMIT=10000                     # Max items per bundle (default: 10000)
# OVERDUE_DATA_ITEM_THRESHOLD_MS=300000         # Overdue threshold (default: 5 minutes)

# BullMQ Worker Concurrency Configuration (optional)
# Control how many jobs each worker processes simultaneously
# Higher values = better throughput, but more CPU/memory/DB connections
# Adjust based on your infrastructure capacity

# Upload processing workers
# WORKER_CONCURRENCY_NEW_DATA_ITEM=10           # Process data item uploads (default: 10)
# WORKER_CONCURRENCY_OPTICAL_POST=10            # AR.IO Gateway optical caching (default: 10)
# WORKER_CONCURRENCY_PUT_OFFSETS=5              # Write data item offsets (default: 5)

# Bundle lifecycle workers
# WORKER_CONCURRENCY_PLAN_BUNDLE=5              # Plan bundle jobs (default: 5)
# WORKER_CONCURRENCY_PREPARE_BUNDLE=5           # Assemble bundles from items (default: 5)
# WORKER_CONCURRENCY_POST_BUNDLE=3              # Post bundles to Arweave (default: 3)
# WORKER_CONCURRENCY_SEED_BUNDLE=3              # Seed bundles to gateways (default: 3)
# WORKER_CONCURRENCY_VERIFY_BUNDLE=3            # Verify bundle posting (default: 3)

# Background workers
# WORKER_CONCURRENCY_UNBUNDLE_BDI=3             # Extract nested bundles (default: 3)
# WORKER_CONCURRENCY_CLEANUP_FS=1               # Filesystem cleanup (default: 1)

# Cache Configuration (optional)
# IN_FLIGHT_DATA_ITEM_TTL_SECS=60               # TTL for in-flight cache (default: 60s)
# IN_FLIGHT_CACHE_CAPACITY=10000                # Max items in local in-flight cache (default: 10000)
# QUARANTINED_SMALL_DATAITEM_TTL_SECS=432000    # TTL for quarantined items (default: 5 days)

# Filesystem Configuration (optional)
# FS_DATA_PATH=/custom/path/to/data             # Custom filesystem path
# TEMP_DIR=temp                                 # Temporary directory (default: temp)

# S3 Advanced (optional - alternative credential names)
# S3_ACCESS_KEY_ID=your-s3-key                  # Alternative to AWS_ACCESS_KEY_ID
# S3_SECRET_ACCESS_KEY=your-s3-secret           # Alternative to AWS_SECRET_ACCESS_KEY
# S3_SESSION_TOKEN=your-session-token           # Session token for temporary credentials
# S3_RETRY_MAX_ATTEMPTS=5                       # Max retry attempts (default: 5)
# S3_RETRY_BASE_DELAY_MS=100                    # Base delay for retries (default: 100ms)
