openapi: 3.0.3
info:
  title: AR.IO Bundler Lite API
  description: |
    Lightweight Arweave ANS-104 bundler with x402 USDC payment integration.

    ## x402 Payment Flow

    1. **Get Price Quote**: `GET /v1/x402/price/{signatureType}/{address}?bytes={size}` (open, no auth required)
    2. **Create EIP-712 Signature**: Sign payment authorization using wallet
    3. **Upload with Payment**:
       - **Signed Data Items**: `POST /x402/upload/signed` (recommended) or `POST /v1/tx` (backwards compatible)
       - **Raw Data**: `POST /x402/upload/unsigned` (bundler creates & signs data item)
    4. **Payment Verification**: Include `X-PAYMENT` header with base64-encoded payment payload
    5. **Finalization** (automatic): Service validates actual byte count and applies fraud detection (±5% tolerance)

    ## Supported Networks

    - **Base Mainnet** (chainId: 8453) - Production USDC payments
    - **Base Sepolia** (chainId: 84532) - Testnet USDC payments
    - **Ethereum Mainnet** (chainId: 1)
    - **Polygon** (chainId: 137)

    ## Authentication

    - **x402 Payment Header**: Base64-encoded JSON containing EIP-712 signature and payment details
    - No API keys required for x402 payments (stateless)
  version: 1.0.0
  contact:
    name: AR.IO Bundler Lite
    url: https://github.com/ar-io/ar-io-bundler
  license:
    name: AGPL-3.0
    url: https://www.gnu.org/licenses/agpl-3.0.html

servers:
  - url: http://localhost:3001
    description: Local development server
  - url: https://api.example.com
    description: Production server (configure as needed)

tags:
  - name: x402
    description: x402 USDC payment endpoints
  - name: upload
    description: Data upload endpoints
  - name: status
    description: Status and information endpoints

paths:
  /v1/x402/price/{signatureType}/{address}:
    get:
      tags:
        - x402
      summary: Get price quote for data upload
      description: |
        Returns the USDC amount required to upload data of a given size.
        Uses the configured network's USDC token and current AR/USD pricing.

        **Price Calculation:**
        1. Convert byte count to Winston credits using current AR/USD rate
        2. Apply network fee multiplier
        3. Convert Winston to USDC atomic units (6 decimals)

        **Note:** Price quotes are valid for a short time window. Create payment immediately after receiving quote.
      operationId: getX402Price
      parameters:
        - name: signatureType
          in: path
          required: true
          description: Arweave signature type (always use 3 for x402/EIP-712)
          schema:
            type: integer
            enum: [3]
            example: 3
        - name: address
          in: path
          required: true
          description: User's EVM wallet address (0x-prefixed)
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{40}$'
            example: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'
        - name: bytes
          in: query
          required: true
          description: Number of bytes to upload
          schema:
            type: integer
            minimum: 1
            maximum: 10737418240
            example: 1024
        - name: network
          in: query
          required: false
          description: EVM network for payment (defaults to base-sepolia for testnet)
          schema:
            type: string
            enum: [base, base-sepolia, ethereum, polygon]
            default: base-sepolia
            example: base-sepolia
      responses:
        '200':
          description: Successful price quote
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/X402PriceQuote'
              example:
                usdcAmount: '50000'
                wincAmount: '1000000000'
                network: base-sepolia
                chainId: 84532
                usdcAddress: '0x036CbD53842c5426634e7929541eC2318f3dCF7e'
                paymentAddress: '0xYourBundlerAddress'
                byteCount: 1024
                expiresAt: '2024-11-04T20:30:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/x402/payment/{signatureType}/{address}:
    post:
      tags:
        - x402
      summary: Verify x402 payment authorization
      description: |
        Verifies an EIP-712 signed payment authorization for data upload.
        This endpoint validates the signature, checks USDC allowance/balance,
        and returns a payment ID to include in the upload request.

        **Payment Verification:**
        1. Validates EIP-712 signature against USDC contract domain
        2. Checks that `from` address has sufficient USDC balance
        3. Verifies USDC allowance for transferWithAuthorization
        4. Checks that authorization hasn't been used (nonce replay protection)
        5. Creates payment record in database

        **Important:** This does NOT transfer funds. Actual USDC transfer occurs
        after upload is finalized and fraud detection passes.
      operationId: verifyX402Payment
      parameters:
        - name: signatureType
          in: path
          required: true
          schema:
            type: integer
            enum: [3]
            example: 3
        - name: address
          in: path
          required: true
          description: User's EVM wallet address (must match signature)
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{40}$'
            example: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/X402PaymentRequest'
            example:
              transferParams:
                from: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'
                to: '0xYourBundlerAddress'
                value: '50000'
                validAfter: 0
                validBefore: 1730754000
                nonce: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef'
              signature: '0xabcdef...'
              network: base-sepolia
              byteCount: 1024
      responses:
        '200':
          description: Payment verified successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/X402PaymentResponse'
              example:
                paymentId: 'pmt_1234567890abcdef'
                status: 'pending_validation'
                wincAmount: '1000000000'
                dataItemId: null
        '400':
          $ref: '#/components/responses/BadRequest'
        '402':
          $ref: '#/components/responses/PaymentRequired'
        '500':
          $ref: '#/components/responses/InternalError'

  /x402/upload/signed:
    post:
      tags:
        - upload
      summary: Upload signed ANS-104 data item (recommended)
      description: |
        **Recommended endpoint** for uploading pre-signed ANS-104 data items with x402 payment.

        This is the explicit, documented way to upload signed data items. Use this when:
        - You have a complete ANS-104 data item with signature
        - You want clear, self-documenting API calls
        - You're building new integrations

        **Flow:**
        1. Create signed ANS-104 data item (signatureType 1=Arweave, 3=Ethereum, 4=Solana)
        2. Get price quote: `GET /v1/x402/price/3/{address}?bytes={size}` (no payment required)
        3. Create EIP-712 signature for USDC payment authorization
        4. Upload with `X-PAYMENT` header containing base64-encoded payment JSON

        **Payment Options:**
        - **With x402 Payment**: Include `X-PAYMENT` header (required for non-whitelisted wallets)
        - **Whitelisted Wallets**: Can upload without payment if wallet is on allow list

        **Fraud Detection:**
        After upload, the service compares `Content-Length` header to actual data size.
        - Within ±5%: Payment confirmed
        - Over 5% under-declared: Full payment charged (fraud penalty)
        - Over 5% over-declared: Excess refunded
      operationId: uploadSignedDataItem
      parameters:
        - name: X-PAYMENT
          in: header
          required: false
          description: |
            Base64-encoded x402 payment payload (required unless wallet is whitelisted).

            **Format:** Base64 encode this JSON:
            ```json
            {
              "transferParams": {
                "from": "0x...",
                "to": "0x...",
                "value": "1234",
                "validAfter": 0,
                "validBefore": 1730754000,
                "nonce": "0x..."
              },
              "signature": "0x...",
              "network": "base-sepolia",
              "byteCount": 1024
            }
            ```
          schema:
            type: string
            format: byte
        - name: Content-Length
          in: header
          required: true
          description: Exact byte count of data item (used for fraud detection)
          schema:
            type: integer
            example: 2048
      requestBody:
        required: true
        description: Binary ANS-104 data item (already signed)
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Data item accepted for bundling
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '402':
          description: Payment required (wallet not whitelisted and no valid payment provided)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
              example:
                error: "Payment required for upload"
                message: "Please provide x402 payment via X-PAYMENT header or use a whitelisted wallet"
        '413':
          description: Payload too large (exceeds MAX_DATA_ITEM_SIZE)
        '500':
          $ref: '#/components/responses/InternalError'

  /x402/upload/unsigned:
    post:
      tags:
        - upload
      summary: Upload raw data (bundler creates & signs data item)
      description: |
        Upload raw data where the bundler creates and signs the ANS-104 data item wrapper.
        Also available at `/v1/x402/upload/unsigned` for consistency.

        This endpoint is designed for AI agents and stateless applications that cannot create
        signed ANS-104 data items. The bundler will:
        - Wrap your raw data in an ANS-104 data item structure
        - Sign it with the bundler's raw data item wallet
        - Add system tags for attribution and payment tracking
        - Verify and settle x402 USDC payment on-chain

        ## Payment Flow

        **Step 1: Get Price Quote (optional)**

        Send request WITHOUT `X-PAYMENT` header to receive 402 with pricing:
        ```
        POST /v1/x402/upload/unsigned
        Content-Type: image/png
        Content-Length: 2087856

        <binary data>
        ```

        **Step 2: Receive 402 Payment Required**
        ```json
        {
          "x402Version": 1,
          "accepts": [{
            "scheme": "exact",
            "network": "base",
            "maxAmountRequired": "30490",
            "payTo": "0x...",
            "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
            "extra": { "name": "USD Coin", "version": "2" }
          }],
          "error": "Payment required to upload data"
        }
        ```

        **Step 3: Create EIP-712 Signature**

        Sign a USDC `transferWithAuthorization` message using the EIP-712 domain from the 402 response.

        **Step 4: Upload with Payment**
        ```
        POST /v1/x402/upload/unsigned
        Content-Type: image/png
        Content-Length: 2087856
        X-PAYMENT: <base64-encoded-payment-payload>

        <binary data>
        ```

        ## Request Formats

        **Option 1: Binary with X-Tag-* Headers**
        ```
        POST /v1/x402/upload/unsigned
        Content-Type: image/png
        Content-Length: 1024
        X-Tag-App-Name: MyApp
        X-Tag-User-Id: user123
        X-PAYMENT: <base64>

        <binary image data>
        ```
        Tags are extracted from `X-Tag-*` headers. Names are converted to proper case:
        `x-tag-app-name` → `App-Name`

        **Option 2: JSON Envelope**
        ```
        POST /v1/x402/upload/unsigned
        Content-Type: application/json
        X-PAYMENT: <base64>

        {
          "data": "<base64-encoded-raw-data>",
          "contentType": "image/png",
          "tags": [
            { "name": "App-Name", "value": "MyApp" },
            { "name": "User-Id", "value": "user123" }
          ]
        }
        ```

        ## System Tags Added

        The bundler automatically adds these tags to every unsigned upload:
        - `Content-Type`: MIME type (if provided)
        - `Bundler`: Service identifier (e.g., "AR.IO Bundler")
        - `Upload-Type`: "raw-data-x402"
        - `Payer-Address`: Ethereum address that paid (from X-PAYMENT)
        - `X402-TX-Hash`: On-chain USDC transaction hash
        - `X402-Payment-ID`: Internal payment tracking UUID
        - `X402-Network`: Network used (e.g., "base", "ethereum-mainnet")
        - `Upload-Timestamp`: Unix timestamp in milliseconds

        ## Owner vs Payer

        - **owner**: The bundler's raw data item wallet (signs the ANS-104 data item)
        - **payer**: The user's Ethereum address (tracked in `Payer-Address` tag)
      operationId: uploadUnsignedData
      parameters:
        - name: X-PAYMENT
          in: header
          required: false
          description: |
            Base64-encoded x402 payment payload. If omitted, returns 402 with payment requirements.

            **Format:** Base64-encode this JSON:
            ```json
            {
              "x402Version": 1,
              "scheme": "exact",
              "network": "base",
              "payload": {
                "signature": "0x...",
                "authorization": {
                  "from": "0xPayerAddress",
                  "to": "0xBundlerPaymentAddress",
                  "value": "30490",
                  "validAfter": 0,
                  "validBefore": 1702598400,
                  "nonce": "0x..."
                }
              }
            }
            ```
          schema:
            type: string
            format: byte
        - name: Content-Type
          in: header
          required: false
          description: MIME type of raw data (added as Content-Type tag)
          schema:
            type: string
            example: "image/png"
        - name: Content-Length
          in: header
          required: true
          description: Exact byte count of raw data
          schema:
            type: integer
        - name: X-Tag-*
          in: header
          required: false
          description: |
            Custom tags via headers (for binary uploads).
            Example: `X-Tag-App-Name: MyApp` becomes tag `{ name: "App-Name", value: "MyApp" }`
          schema:
            type: string
      requestBody:
        required: true
        description: |
          Raw data in one of two formats:

          **Binary**: Any content type with optional X-Tag-* headers

          **JSON Envelope**: `{ "data": "base64...", "tags": [...], "contentType": "..." }`
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
          image/*:
            schema:
              type: string
              format: binary
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: string
                  format: byte
                  description: Base64-encoded raw data
                tags:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      value:
                        type: string
                contentType:
                  type: string
                  description: MIME type for Content-Type tag
              required:
                - data
          text/plain:
            schema:
              type: string
      responses:
        '201':
          description: Data wrapped, signed, and accepted for bundling
          headers:
            X-Payment-Response:
              description: Base64-encoded payment confirmation
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnsignedUploadResponse'
              example:
                id: "50BxW6W_8tj8GH94aY7u7DUQtyYNE5zi9UyHdnaHBLo"
                owner: "X1Yxv69On-bZomhLdyvXiELvGG4z6D4dDMT89k2rtnU"
                payer: "0xUserWalletAddress"
                dataCaches: ["arweave.net"]
                fastFinalityIndexes: ["arweave.net"]
                receipt:
                  id: "50BxW6W_8tj8GH94aY7u7DUQtyYNE5zi9UyHdnaHBLo"
                  timestamp: 1702512345678
                  version: "0.2.0"
                  deadlineHeight: 1234567
                  dataCaches: ["arweave.net"]
                  fastFinalityIndexes: ["arweave.net"]
                  winc: "7699496221"
                  public: "<bundler-public-key>"
                  signature: "<receipt-signature>"
                x402Payment:
                  paymentId: "550e8400-e29b-41d4-a716-446655440000"
                  transactionHash: "0x..."
                  network: "base"
                  mode: "payg"
        '400':
          $ref: '#/components/responses/BadRequest'
        '402':
          description: Payment required (no X-PAYMENT header) or payment verification failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/X402PaymentRequiredResponse'
              example:
                x402Version: 1
                accepts:
                  - scheme: "exact"
                    network: "base"
                    maxAmountRequired: "30490"
                    resource: "https://bundler.example.com/v1/tx"
                    description: "Upload 2088107 bytes to Arweave via AR.IO Bundler"
                    mimeType: "image/png"
                    payTo: "0xCFd3f996447a541Cbfba5422310EDb417d9f2cE6"
                    maxTimeoutSeconds: 3600
                    asset: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
                    extra:
                      name: "USD Coin"
                      version: "2"
                error: "Payment required to upload data"
        '403':
          description: Raw data uploads not enabled on this bundler
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Raw data uploads are not enabled on this bundler"
        '413':
          description: Payload too large (exceeds 10 GB limit)
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/x402/upload/unsigned:
    post:
      tags:
        - upload
      summary: Upload raw data (with /v1 prefix)
      description: |
        **Identical to `/x402/upload/unsigned`** - provided for URL consistency.

        See `/x402/upload/unsigned` for full documentation.
      operationId: uploadUnsignedDataV1
      parameters:
        - name: X-PAYMENT
          in: header
          required: false
          schema:
            type: string
            format: byte
        - name: Content-Type
          in: header
          required: false
          schema:
            type: string
        - name: Content-Length
          in: header
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
          application/json:
            schema:
              type: object
      responses:
        '201':
          description: Data accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnsignedUploadResponse'
        '402':
          description: Payment required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/X402PaymentRequiredResponse'
        '403':
          description: Raw data uploads not enabled
        '500':
          $ref: '#/components/responses/InternalError'

  /price/x402/data-item/{token}/{byteCount}:
    get:
      tags:
        - x402
      summary: Get price for signed data item (Turbo-style)
      description: |
        Returns x402 payment requirements for uploading a complete, signed ANS-104 data item.

        **Use this endpoint when you:**
        - Already have a signed ANS-104 data item
        - Know the exact byte count of your data item

        **Token Format:** `{currency}-{network}`
        - `usdc-base` - USDC on Base mainnet
        - `usdc-base-sepolia` - USDC on Base Sepolia testnet
        - `usdc-ethereum-mainnet` - USDC on Ethereum
        - `usdc-polygon-mainnet` - USDC on Polygon

        **Pricing:**
        1. Byte count → Winston cost (via Arweave pricing)
        2. Add 30% bundler fee (profit margin on top of Arweave costs)
        3. Winston → USDC atomic units (via CoinGecko AR/USD rate)
        4. Apply minimum threshold (0.001 USDC = 1,000 atomic units)

        Returns standard x402 v1 payment requirements.
      operationId: getX402DataItemPrice
      parameters:
        - name: token
          in: path
          required: true
          description: Payment token in format {currency}-{network}
          schema:
            type: string
            enum: [usdc-base, usdc-base-sepolia, usdc-ethereum-mainnet, usdc-polygon-mainnet]
            example: usdc-base
        - name: byteCount
          in: path
          required: true
          description: Exact byte count of signed data item
          schema:
            type: integer
            minimum: 1
            maximum: 10737418240
            example: 2048
      responses:
        '200':
          description: x402 payment requirements
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/X402PaymentRequiredResponse'
              example:
                x402Version: 1
                accepts:
                  - scheme: exact
                    network: base
                    maxAmountRequired: "1234"
                    resource: "http://localhost:3001/v1/tx"
                    description: "Upload data to Arweave via AR.IO Bundler"
                    payTo: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
                    maxTimeoutSeconds: 300
                    asset: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
                    extra:
                      name: "USD Coin"
                      version: "2"
        '400':
          description: Invalid token or byte count
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  token:
                    type: string
                  supported:
                    type: array
                    items:
                      type: string
              example:
                error: "Invalid or unsupported token"
                token: "invalid-token"
                supported: ["usdc-base", "usdc-base-sepolia"]
        '500':
          $ref: '#/components/responses/InternalError'

  /price/x402/data/{token}/{byteCount}:
    get:
      tags:
        - x402
      summary: Get price for raw data (bundler creates data item)
      description: |
        Returns x402 payment requirements for uploading raw data where the bundler
        will create the ANS-104 data item wrapper.

        **Use this endpoint when you:**
        - Have raw data (not a signed data item)
        - Want the bundler to create and sign the data item
        - Need pricing that includes ANS-104 wrapper overhead

        **Overhead Estimation:**
        The final data item size is estimated by adding:
        - Raw data bytes (your data)
        - ANS-104 wrapper (~1.1 KB for signature, owner, headers)
        - User tags (if provided via `tags` parameter)
        - Content-Type tag (if provided via `contentType` parameter)
        - System tags (7 x402 metadata tags)

        **System Tags Added:**
        1. Bundler
        2. Upload-Type
        3. Payer-Address
        4. X402-TX-Hash
        5. X402-Payment-ID
        6. X402-Network
        7. Upload-Timestamp

        **Response includes `sizeBreakdown`** showing detailed size calculation.
      operationId: getX402RawDataPrice
      parameters:
        - name: token
          in: path
          required: true
          description: Payment token in format {currency}-{network}
          schema:
            type: string
            enum: [usdc-base, usdc-base-sepolia, usdc-ethereum-mainnet, usdc-polygon-mainnet]
            example: usdc-base
        - name: byteCount
          in: path
          required: true
          description: Raw data byte count (before ANS-104 wrapping)
          schema:
            type: integer
            minimum: 1
            maximum: 10737418240
            example: 1024
        - name: tags
          in: query
          required: false
          description: Number of user tags to include
          schema:
            type: integer
            minimum: 0
            maximum: 100
            default: 0
            example: 3
        - name: contentType
          in: query
          required: false
          description: MIME type (adds Content-Type tag if provided)
          schema:
            type: string
            example: "image/png"
      responses:
        '200':
          description: x402 payment requirements with size breakdown
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/X402PaymentRequiredResponse'
                  - type: object
                    properties:
                      sizeBreakdown:
                        type: object
                        properties:
                          rawDataBytes:
                            type: integer
                            description: Original raw data size
                          ans104Overhead:
                            type: integer
                            description: ANS-104 wrapper + tags overhead
                          estimatedTotalBytes:
                            type: integer
                            description: Final estimated data item size
                          tagCount:
                            type: object
                            properties:
                              user:
                                type: integer
                              contentType:
                                type: integer
                              system:
                                type: integer
                              total:
                                type: integer
              example:
                x402Version: 1
                sizeBreakdown:
                  rawDataBytes: 1024
                  ans104Overhead: 1317
                  estimatedTotalBytes: 2341
                  tagCount:
                    user: 3
                    contentType: 1
                    system: 7
                    total: 11
                accepts:
                  - scheme: exact
                    network: base
                    maxAmountRequired: "1456"
                    resource: "http://localhost:3001/v1/tx"
                    description: "Upload data to Arweave via AR.IO Bundler"
                    payTo: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
                    maxTimeoutSeconds: 300
                    asset: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
        '400':
          description: Invalid token, byte count, or tags parameter
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
              example:
                error: "Invalid tags parameter"
                message: "tags must be a non-negative integer"
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/price/x402/data-item/{token}/{byteCount}:
    get:
      tags:
        - x402
      summary: Get price for signed data item (with /v1 prefix)
      description: |
        **Identical to `/price/x402/data-item/{token}/{byteCount}`**

        This endpoint is the same as the non-prefixed version, provided for consistency.
        See `/price/x402/data-item/{token}/{byteCount}` for full documentation.
      operationId: getX402DataItemPriceV1
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            enum: [usdc-base, usdc-base-sepolia, usdc-ethereum-mainnet, usdc-polygon-mainnet]
        - name: byteCount
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 10737418240
      responses:
        '200':
          description: x402 payment requirements
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/X402PaymentRequiredResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/price/x402/data/{token}/{byteCount}:
    get:
      tags:
        - x402
      summary: Get price for raw data (with /v1 prefix)
      description: |
        **Identical to `/price/x402/data/{token}/{byteCount}`**

        This endpoint is the same as the non-prefixed version, provided for consistency.
        See `/price/x402/data/{token}/{byteCount}` for full documentation.
      operationId: getX402RawDataPriceV1
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            enum: [usdc-base, usdc-base-sepolia, usdc-ethereum-mainnet, usdc-polygon-mainnet]
        - name: byteCount
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 10737418240
        - name: tags
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            maximum: 100
        - name: contentType
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: x402 payment requirements with size breakdown
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/X402PaymentRequiredResponse'
                  - type: object
                    properties:
                      sizeBreakdown:
                        type: object
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/tx:
    post:
      tags:
        - upload
      summary: Upload data item (auto-detects signed vs unsigned)
      description: |
        **Legacy/backwards-compatible endpoint** that auto-detects content type.

        This endpoint maintains backwards compatibility with existing clients by detecting
        whether the payload is a signed ANS-104 data item or raw data.

        **Detection Logic:**
        - If binary data starts with ANS-104 signature → treats as signed data item
        - Otherwise → treats as raw data and wraps in ANS-104 data item

        **⚠️ Deprecation Notice:**
        For new integrations, use the explicit endpoints instead:
        - `POST /x402/upload/signed` - for signed data items
        - `POST /x402/upload/unsigned` - for raw data

        The explicit endpoints provide clearer API semantics and better documentation.

        **Payment:**
        - Whitelisted wallets can upload signed data items without payment
        - All other uploads require x402 payment via `X-PAYMENT` header
      operationId: uploadDataItem
      parameters:
        - name: X-PAYMENT
          in: header
          required: false
          description: |
            Base64-encoded x402 payment payload (required for non-whitelisted wallets).

            For backwards compatibility with existing clients.
          schema:
            type: string
            format: byte
            example: 'eyJwYXltZW50SWQiOiJwbXRfMTIzNCIsInNpZ25hdHVyZSI6IjB4Li4uIn0='
      requestBody:
        required: true
        description: Signed ANS-104 data item binary
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Data item accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
              example:
                id: 'abcdef1234567890abcdef1234567890abcdef1234567890'
                dataCaches: ['arweave.net']
                fastFinalityIndexes: []
                owner: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'
                signature: '0x...'
                deadlineHeight: 1000000
                block: 950000
                validatorSignatures: []
                timestamp: 1730750000000
                version: '1.0.0'
                public: null
        '400':
          $ref: '#/components/responses/BadRequest'
        '402':
          $ref: '#/components/responses/PaymentRequired'
        '413':
          description: Payload too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'Data item exceeds maximum size of 10GB'
        '500':
          $ref: '#/components/responses/InternalError'

  /x402/data-item/signed:
    post:
      tags:
        - upload
      summary: Upload signed data item (backwards compatible)
      description: |
        **Backwards-compatible endpoint** for uploading signed ANS-104 data items.

        This endpoint exists for compatibility with clients expecting the `/x402/data-item/signed` path.
        It behaves identically to `/v1/tx` (auto-detection of content type).

        **⚠️ Deprecation Notice:**
        New integrations should use `/x402/upload/signed` instead for clearer API semantics.

        See `/x402/upload/signed` for full documentation.
      operationId: uploadSignedDataItemLegacy
      parameters:
        - name: X-PAYMENT
          in: header
          required: false
          description: Base64-encoded x402 payment payload (required for non-whitelisted wallets)
          schema:
            type: string
            format: byte
      requestBody:
        required: true
        description: Binary ANS-104 data item
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Data item accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '402':
          $ref: '#/components/responses/PaymentRequired'
        '413':
          description: Payload too large
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/tx/{id}/status:
    get:
      tags:
        - status
      summary: Get data item status
      description: |
        Returns the current status of an uploaded data item.

        **Status Values:**
        - `pending`: Uploaded, waiting to be bundled
        - `bundled`: Included in a bundle, waiting to be posted
        - `posted`: Posted to Arweave, waiting for confirmation
        - `permanent`: Confirmed on Arweave blockchain
        - `failed`: Upload or bundling failed
      operationId: getDataItemStatus
      parameters:
        - name: id
          in: path
          required: true
          description: Data item transaction ID
          schema:
            type: string
            minLength: 43
            maxLength: 43
            example: 'abcdef1234567890abcdef1234567890abcdef1234567890'
      responses:
        '200':
          description: Status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataItemStatus'
              example:
                id: 'abcdef1234567890abcdef1234567890abcdef1234567890'
                status: 'permanent'
                bundleId: 'bundle_1234567890abcdef'
                blockHeight: 1000500
                blockTimestamp: 1730760000
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/tx/{id}/offsets:
    get:
      tags:
        - status
      summary: Get data item offset information
      description: |
        Returns offset information for retrieving the data item from Arweave.
        Only available after the data item has been posted to Arweave.
      operationId: getDataItemOffsets
      parameters:
        - name: id
          in: path
          required: true
          description: Data item transaction ID
          schema:
            type: string
            example: 'abcdef1234567890abcdef1234567890abcdef1234567890'
      responses:
        '200':
          description: Offset information retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataItemOffset'
              example:
                id: 'abcdef1234567890abcdef1234567890abcdef1234567890'
                offset: 123456789
                size: 1024
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/info:
    get:
      tags:
        - status
      summary: Get service information
      description: Returns bundler service version and configuration details
      operationId: getInfo
      responses:
        '200':
          description: Service information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInfo'
              example:
                version: '1.0.0'
                x402Enabled: true
                supportedNetworks: ['base', 'base-sepolia', 'ethereum', 'polygon']
                maxUploadSize: 10737418240

  /health:
    get:
      tags:
        - status
      summary: Health check endpoint
      description: |
        Returns a simple "OK" response to verify the service is running.
        Used by monitoring systems and load balancers to check service health.
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            text/plain:
              schema:
                type: string
                example: "OK"

  /openapi.json:
    get:
      tags:
        - status
      summary: Get OpenAPI specification
      description: Returns this OpenAPI spec as JSON
      operationId: getOpenApiSpec
      responses:
        '200':
          description: OpenAPI specification
          content:
            application/json:
              schema:
                type: object

components:
  schemas:
    X402PriceQuote:
      type: object
      required:
        - usdcAmount
        - wincAmount
        - network
        - chainId
        - usdcAddress
        - paymentAddress
        - byteCount
        - expiresAt
      properties:
        usdcAmount:
          type: string
          description: USDC amount in atomic units (6 decimals) as string
          example: '50000'
        wincAmount:
          type: string
          description: Equivalent Winston credits as string
          example: '1000000000'
        network:
          type: string
          description: EVM network identifier
          enum: [base, base-sepolia, ethereum, polygon]
          example: 'base-sepolia'
        chainId:
          type: integer
          description: EVM chain ID
          example: 84532
        usdcAddress:
          type: string
          description: USDC token contract address
          pattern: '^0x[a-fA-F0-9]{40}$'
          example: '0x036CbD53842c5426634e7929541eC2318f3dCF7e'
        paymentAddress:
          type: string
          description: Bundler's payment receiver address
          pattern: '^0x[a-fA-F0-9]{40}$'
          example: '0xYourBundlerAddress'
        byteCount:
          type: integer
          description: Number of bytes quoted
          example: 1024
        expiresAt:
          type: string
          format: date-time
          description: Quote expiration timestamp (ISO 8601)
          example: '2024-11-04T20:30:00Z'

    X402PaymentRequest:
      type: object
      required:
        - transferParams
        - signature
        - network
      properties:
        transferParams:
          $ref: '#/components/schemas/TransferParams'
        signature:
          type: string
          description: EIP-712 signature (0x-prefixed hex)
          pattern: '^0x[a-fA-F0-9]{130}$'
          example: '0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab'
        network:
          type: string
          enum: [base, base-sepolia, ethereum, polygon]
          example: 'base-sepolia'
        byteCount:
          type: integer
          minimum: 1
          description: Declared byte count for fraud detection
          example: 1024

    TransferParams:
      type: object
      description: EIP-3009 transferWithAuthorization parameters
      required:
        - from
        - to
        - value
        - validAfter
        - validBefore
        - nonce
      properties:
        from:
          type: string
          description: Payer's EVM address
          pattern: '^0x[a-fA-F0-9]{40}$'
          example: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'
        to:
          type: string
          description: Bundler's payment receiver address
          pattern: '^0x[a-fA-F0-9]{40}$'
          example: '0xYourBundlerAddress'
        value:
          type: string
          description: USDC amount in atomic units (6 decimals)
          example: '50000'
        validAfter:
          type: integer
          description: Unix timestamp after which authorization is valid
          example: 0
        validBefore:
          type: integer
          description: Unix timestamp before which authorization expires
          example: 1730754000
        nonce:
          type: string
          description: Random 32-byte hex string for replay protection
          pattern: '^0x[a-fA-F0-9]{64}$'
          example: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef'

    X402PaymentResponse:
      type: object
      required:
        - paymentId
        - status
        - wincAmount
      properties:
        paymentId:
          type: string
          description: Unique payment identifier
          example: 'pmt_1234567890abcdef'
        status:
          type: string
          enum: [pending_validation, confirmed, refunded, fraud_penalty]
          description: Current payment status
          example: 'pending_validation'
        wincAmount:
          type: string
          description: Winston credits allocated
          example: '1000000000'
        dataItemId:
          type: string
          nullable: true
          description: Associated data item ID (null until upload)
          example: null

    UploadResponse:
      type: object
      required:
        - id
        - timestamp
      properties:
        id:
          type: string
          description: Data item transaction ID
          example: 'abcdef1234567890abcdef1234567890abcdef1234567890'
        dataCaches:
          type: array
          items:
            type: string
          description: List of caches that will index this data
          example: ['arweave.net']
        fastFinalityIndexes:
          type: array
          items:
            type: string
          description: Fast finality indexes
          example: []
        owner:
          type: string
          description: Owner address
          example: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'
        signature:
          type: string
          description: Data item signature
          example: '0x...'
        deadlineHeight:
          type: integer
          description: Arweave block height deadline
          example: 1000000
        block:
          type: integer
          description: Current Arweave block height
          example: 950000
        validatorSignatures:
          type: array
          items:
            type: string
          example: []
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp (milliseconds)
          example: 1730750000000
        version:
          type: string
          description: API version
          example: '1.0.0'
        public:
          type: string
          nullable: true
          description: Public key (if applicable)
          example: null

    UnsignedUploadResponse:
      type: object
      description: Response for unsigned raw data uploads
      required:
        - id
        - owner
        - payer
        - receipt
        - x402Payment
      properties:
        id:
          type: string
          description: ANS-104 data item ID (base64url-encoded SHA-256)
          example: '50BxW6W_8tj8GH94aY7u7DUQtyYNE5zi9UyHdnaHBLo'
        owner:
          type: string
          description: Arweave address of the bundler's raw data item wallet (signer)
          example: 'X1Yxv69On-bZomhLdyvXiELvGG4z6D4dDMT89k2rtnU'
        payer:
          type: string
          description: Ethereum address that paid for the upload (from X-PAYMENT header)
          pattern: '^0x[a-fA-F0-9]{40}$'
          example: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'
        dataCaches:
          type: array
          items:
            type: string
          description: List of caches that will index this data
          example: ['arweave.net']
        fastFinalityIndexes:
          type: array
          items:
            type: string
          description: Fast finality indexes
          example: ['arweave.net']
        receipt:
          $ref: '#/components/schemas/SignedReceipt'
        x402Payment:
          type: object
          description: x402 payment confirmation details
          required:
            - paymentId
            - transactionHash
            - network
            - mode
          properties:
            paymentId:
              type: string
              format: uuid
              description: Internal payment tracking UUID
              example: '550e8400-e29b-41d4-a716-446655440000'
            transactionHash:
              type: string
              description: On-chain USDC transfer transaction hash
              pattern: '^0x[a-fA-F0-9]{64}$'
              example: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef'
            network:
              type: string
              description: Network where payment was settled
              enum: [base, base-sepolia, ethereum-mainnet, polygon-mainnet]
              example: 'base'
            mode:
              type: string
              description: Payment mode (always "payg" for x402)
              enum: [payg]
              example: 'payg'

    SignedReceipt:
      type: object
      description: Cryptographically signed receipt proving upload acceptance
      required:
        - id
        - timestamp
        - version
        - deadlineHeight
        - winc
        - public
        - signature
      properties:
        id:
          type: string
          description: Data item ID
          example: '50BxW6W_8tj8GH94aY7u7DUQtyYNE5zi9UyHdnaHBLo'
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp in milliseconds
          example: 1702512345678
        version:
          type: string
          description: Receipt version
          example: '0.2.0'
        deadlineHeight:
          type: integer
          description: Arweave block height by which data must be posted
          example: 1234567
        dataCaches:
          type: array
          items:
            type: string
          example: ['arweave.net']
        fastFinalityIndexes:
          type: array
          items:
            type: string
          example: ['arweave.net']
        winc:
          type: string
          description: Winston credits paid (as string for precision)
          example: '7699496221'
        public:
          type: string
          description: Base64url-encoded public key of receipt signer
          example: 'nQ9iy1fRM2xrgggjHhN1xZUnOkm9B4KFsJcH...'
        signature:
          type: string
          description: Base64url-encoded signature over receipt fields
          example: 'kYp3hVm2xQ5rN8sT1uW0vX4yZ7a9b2c3d4e5f6g7h8i9j0...'

    DataItemStatus:
      type: object
      required:
        - id
        - status
      properties:
        id:
          type: string
          description: Data item transaction ID
          example: 'abcdef1234567890abcdef1234567890abcdef1234567890'
        status:
          type: string
          enum: [pending, bundled, posted, permanent, failed]
          description: Current processing status
          example: 'permanent'
        bundleId:
          type: string
          nullable: true
          description: Bundle transaction ID (if bundled)
          example: 'bundle_1234567890abcdef'
        blockHeight:
          type: integer
          nullable: true
          description: Arweave block height (if confirmed)
          example: 1000500
        blockTimestamp:
          type: integer
          nullable: true
          format: int64
          description: Block timestamp (if confirmed)
          example: 1730760000

    DataItemOffset:
      type: object
      required:
        - id
        - offset
        - size
      properties:
        id:
          type: string
          description: Data item transaction ID
          example: 'abcdef1234567890abcdef1234567890abcdef1234567890'
        offset:
          type: integer
          format: int64
          description: Byte offset in bundle
          example: 123456789
        size:
          type: integer
          description: Data item size in bytes
          example: 1024

    X402PaymentRequiredResponse:
      type: object
      description: Standard x402 v1 payment requirements response
      required:
        - x402Version
        - accepts
      properties:
        x402Version:
          type: integer
          description: x402 protocol version
          enum: [1]
          example: 1
        accepts:
          type: array
          description: List of acceptable payment methods
          minItems: 1
          items:
            type: object
            required:
              - scheme
              - network
              - maxAmountRequired
              - resource
              - description
              - payTo
              - maxTimeoutSeconds
              - asset
            properties:
              scheme:
                type: string
                enum: [exact]
                description: Payment scheme (always "exact" for fixed-price uploads)
              network:
                type: string
                description: EVM network identifier (e.g., "base", "base-sepolia")
                example: base
              maxAmountRequired:
                type: string
                description: Maximum USDC amount required in atomic units (6 decimals)
                example: "1234"
              resource:
                type: string
                format: uri
                description: Upload endpoint URL
                example: "http://localhost:3001/v1/tx"
              description:
                type: string
                description: Human-readable description of the service
                example: "Upload data to Arweave via AR.IO Bundler"
              mimeType:
                type: string
                description: Response content type
                default: "application/json"
              outputSchema:
                type: object
                description: JSON schema describing the upload response structure
                additionalProperties: true
              payTo:
                type: string
                pattern: '^0x[a-fA-F0-9]{40}$'
                description: Bundler's payment receiver address
                example: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
              maxTimeoutSeconds:
                type: integer
                description: Maximum time to complete payment (seconds)
                example: 300
              asset:
                type: string
                pattern: '^0x[a-fA-F0-9]{40}$'
                description: USDC token contract address on the specified network
                example: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
              extra:
                type: object
                description: Additional token metadata for EIP-712 domain
                properties:
                  name:
                    type: string
                    description: Token name
                    example: "USD Coin"
                  version:
                    type: string
                    description: EIP-712 domain version for USDC contract
                    example: "2"

    ServiceInfo:
      type: object
      required:
        - version
        - x402Enabled
      properties:
        version:
          type: string
          description: Service version
          example: '1.0.0'
        x402Enabled:
          type: boolean
          description: Whether x402 payments are enabled
          example: true
        supportedNetworks:
          type: array
          items:
            type: string
          description: List of supported EVM networks
          example: ['base', 'base-sepolia', 'ethereum', 'polygon']
        maxUploadSize:
          type: integer
          format: int64
          description: Maximum upload size in bytes
          example: 10737418240

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: 'Invalid payment authorization'
        code:
          type: string
          description: Error code (optional)
          example: 'INVALID_SIGNATURE'
        details:
          type: object
          description: Additional error details (optional)
          additionalProperties: true

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 'Invalid byte count parameter'
            code: 'BAD_REQUEST'

    PaymentRequired:
      description: Payment required - x402 payment failed or insufficient
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 'Invalid payment signature'
            code: 'PAYMENT_REQUIRED'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 'Data item not found'
            code: 'NOT_FOUND'

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 'Internal server error'
            code: 'INTERNAL_ERROR'

  securitySchemes:
    X402Payment:
      type: apiKey
      in: header
      name: X-PAYMENT
      description: |
        Base64-encoded JSON containing x402 payment authorization.

        **Structure:**
        ```json
        {
          "paymentId": "pmt_xxx",
          "signature": "0x...",
          "transferParams": {
            "from": "0x...",
            "to": "0x...",
            "value": "50000",
            "validAfter": 0,
            "validBefore": 1730754000,
            "nonce": "0x..."
          },
          "network": "base-sepolia"
        }
        ```

security:
  - X402Payment: []
